# Makefile do testÃ³w backendu

.PHONY: help install test test-unit test-routers test-integration test-coverage clean

# DomyÅ›lna akcja
help:
	@echo "ğŸ§ª DostÄ™pne komendy testowe:"
	@echo ""
	@echo "  make install         - Zainstaluj zaleÅ¼noÅ›ci testowe"
	@echo "  make test           - Uruchom wszystkie podstawowe testy"
	@echo "  make test-unit      - Uruchom tylko testy jednostkowe"
	@echo "  make test-routers   - Uruchom tylko testy routerÃ³w"
	@echo "  make test-integration - Uruchom testy integracyjne"
	@echo "  make test-coverage  - Uruchom testy z pokryciem kodu"
	@echo "  make clean          - WyczyÅ›Ä‡ pliki testowe"
	@echo ""

# Instalacja zaleÅ¼noÅ›ci
install:
	@echo "ğŸ“¦ Instalowanie zaleÅ¼noÅ›ci testowych..."
	pip install -r requirements-test.txt

# Podstawowe testy (bez integracyjnych)
test:
	@echo "ğŸ§ª Uruchamianie podstawowych testÃ³w..."
	pytest test_services.py test_routers.py -v

# Tylko testy jednostkowe
test-unit:
	@echo "ğŸ”§ Uruchamianie testÃ³w jednostkowych..."
	pytest test_services.py -v

# Tylko testy routerÃ³w
test-routers:
	@echo "ğŸŒ Uruchamianie testÃ³w routerÃ³w..."
	pytest test_routers.py -v

# Testy integracyjne (wymagajÄ… dziaÅ‚ajÄ…cej bazy)
test-integration:
	@echo "ğŸ”— Uruchamianie testÃ³w integracyjnych..."
	pytest -m integration -v

# Testy z pokryciem kodu
test-coverage:
	@echo "ğŸ“Š Uruchamianie testÃ³w z analizÄ… pokrycia..."
	pytest --cov=services --cov=models --cov-report=html --cov-report=term -v
	@echo "ğŸ“ˆ Raport HTML: htmlcov/index.html"

# Szybkie testy (bez verbose)
test-quick:
	@echo "âš¡ Szybkie testy..."
	pytest test_services.py test_routers.py -q

# Testy z szczegÃ³Å‚owym logowaniem
test-verbose:
	@echo "ğŸ” SzczegÃ³Å‚owe testy..."
	pytest test_services.py test_routers.py -v -s

# Testy konkretnej funkcji/klasy
test-specific:
	@echo "ğŸ¯ Uruchom konkretny test:"
	@echo "PrzykÅ‚ad: make test-file FILE=test_services.py::TestParagonService::test_get_user_id_by_token_success"
	
test-file:
	pytest $(FILE) -v

# Czyszczenie
clean:
	@echo "ğŸ§¹ Czyszczenie plikÃ³w testowych..."
	rm -rf htmlcov/
	rm -rf .pytest_cache/
	rm -rf __pycache__/
	rm -rf .coverage
	find . -name "*.pyc" -delete
	find . -name "__pycache__" -type d -delete

# Przygotowanie Å›rodowiska testowego
setup-test-env:
	@echo "âš™ï¸ Przygotowywanie Å›rodowiska testowego..."
	python -m venv test_env
	source test_env/bin/activate && pip install -r requirements-test.txt
	@echo "âœ… Åšrodowisko testowe gotowe. Aktywuj przez: source test_env/bin/activate"

# Sprawdzenie jakoÅ›ci kodu
lint:
	@echo "ğŸ§¹ Sprawdzanie jakoÅ›ci kodu..."
	@if command -v flake8 >/dev/null 2>&1; then \
		flake8 services/ models/ --max-line-length=100; \
	else \
		echo "âš ï¸ flake8 nie jest zainstalowany. InstalujÄ™..."; \
		pip install flake8; \
		flake8 services/ models/ --max-line-length=100; \
	fi

# Formatowanie kodu
format:
	@echo "âœ¨ Formatowanie kodu..."
	@if command -v black >/dev/null 2>&1; then \
		black services/ models/ --line-length=100; \
	else \
		echo "âš ï¸ black nie jest zainstalowany. InstalujÄ™..."; \
		pip install black; \
		black services/ models/ --line-length=100; \
	fi

# PeÅ‚ny workflow: format + lint + test
full-check: format lint test
	@echo "âœ… PeÅ‚ne sprawdzenie zakoÅ„czone!"

# Pomoc dla konkretnych testÃ³w
test-help:
	@echo "ğŸ¯ Jak uruchomiÄ‡ konkretne testy:"
	@echo ""
	@echo "  pytest test_services.py::TestParagonService::test_get_user_id_by_token_success"
	@echo "  pytest test_routers.py::TestReceiptRouter -v"
	@echo "  pytest -k 'test_save_receipt' -v"
	@echo "  pytest --lf  # Tylko ostatnio nieudane"
	@echo "  pytest --tb=short  # KrÃ³tkie tracebacki"
	@echo ""